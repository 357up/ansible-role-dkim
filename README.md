# ansible-dkim
A simple Ansible role for adding opendkim to postfix. The role will install postfix if it's not already present.


### Requirements

- Ubuntu >= 14 or CentOS 6
- Postfix

### Role variables
- `dkim_selector`

  This is used to identify which server or system is signing outgoing email.

  Whatever you specify here will be used by remote systems to requst DNS records. EG if your dkim selector is `foo`, and your domain is `example.com`, remote systems will look for your public DKIM key at `foo._domainkey.exmaple.com`.

  If you don't have a reason to change this, or if your domain only has one server using DKIM, then you can just leave this as the string `default`.

  If your domain uses dkim on more than one server, you can use this to specify individual servers. This way, you don't necessarily need to share private keys among multiple servers. Every server can sign mail with its own internally generated key, and you'd set up individual DNS verification records for each server.


- `dkim_domains`

  A list of domains that you want to generate private DKIM keys for. If you're providing (uploading) your own private key, it will overwrite the key that was generated by the role.


- `dkim_wildcard_sign_all_with_domain`

  Optional. For servers that need to sign mail from domains that don't have their own key (ie. a web server with multiple virtual hosts on it).

  Caveat No.1: If you use the "wildcard sign all" option, email recipients may see things like:

  ```
  From: sender@somedomain.com (via example.org)
  ```
  Where `somedomain.com` is the website that generated the email, but does not have its own DKIM key, and `example.org` is the domain key used to sign the outgoing message.

  Caveat No. 2: You must also include the value specified for `dkim_wildcard_sign_all_with_domain` in your list of `dkim_domains`.



- `dkim_report_recipient`

  Optional: Who will receive signature failure reports?

- `dkim_path_to_wildcard_key`

Optional. The path (on your local machine) to the private key that will be used for wildcard signing. If specified, the role will upload it to `/etc/opendkim/keys/{{ dkim_wildcard_sign_all_with_domain }}/default.private` on your server. **Be sure to avoid committing private keys to repositories.**

### Dependencies

- If postfix isn't already installed, this role will install it.

- If you're using CentOS, you will need to apply an opendkim SELinux policy separately, otherwise you will experience errors.


### Example playbooks
Let the role generate keys for each app node in your system:
```yaml
---
- hosts: app-nodes
  become: true
  roles:
    - role: AcroMedia.dkim
      vars:
        dkim_selector: "{{ inventory_hostname_short }}"
        dkim_domains:
         - example.com
        dkim_report_recipient: somebody@example.com
        # You'll need to log in and retreive public
        # keys and create DNS records from each app node
        # after the role is done.
```

Take responsibility for all outgoing mail on your server:
```yaml
---
- hosts: my-shared-server-with-many-vhosts-and-domains
  become: true
  roles:
    - role: AcroMedia.dkim
      vars:
        dkim_selector: default
        dkim_domains:
         - example.org
         - domain2.tld
        dkim_wildcard_sign_all_with_domain: example.org
        dkim_report_recipient: somebody@example.org
        dkim_path_to_wildcard_key: /local/path/to/private/dkim-rsa-keys/example.org.key
        # Since you have the private key, you can create DNS
        # records for DKIM beforehand.
```

### How to retreive your public DKIM key for use in DNS record creation

If you didn't upload your private key, the role will have generated a private and public key for DKIM signing.

For Ubuntu, the public half will be on the server at:
```
/etc/opendkim/keys/{{ dkim_domain }}/{{ dkim_selector }}.txt
```
Its contents will look something like:
```
foo._domainkey	IN	TXT	( "v=DKIM1; k=rsa; "
	  "p=MIGfMx... truncated for readability ...XIDAQAB" )  ; ----- DKIM public key "foo" selector for "example.com" domain
```
Which you would use to create a DNS TXT record that looks like:
```
foo._domainkey.example.com. 3600 IN TXT "v=DKIM1; k=rsa; p=MIGfMx... truncated for readability ...XIDAQAB"
```

If you generated your own private RSA key, the easiest way to extract the public half in the correct format is with ssh-keygen:
```bash 
ssh-keygen -y -f /path/to/rsa-private-key  
# ^^^ The public key will be everything after the `ssh-rsa` prefix
```
You can also extract it with `openssl rsa -in /path/to/rsa-private-key -pubout` but then you have to extract the key and strip line breaks, which is more work.
